# -*- coding: utf-8 -*-
import os
import requests

from tornado.options import define

define("port", default=9900, help="run on the given port", type=int)

gateway_addr = os.popen("ip route show | awk '/default/ {print $3}'").read().strip()
#gateway_addr = "127.0.0.1"
SYS_CONF = {
    "webconfig_addr": "http://{}:9999/api/v1/device/register".format(gateway_addr),
    "external_port": int(os.getenv("EXTERNAL_PORT")),  # 对外提供的端口
    "mongodb": {
        "addr": "mongodb://{}:27017".format(gateway_addr),
        "db": "w2s"
    },

    "mqtt": {
        "addr": os.getenv("MQTT_BROKER_ADDR"),
        "port": int(os.getenv("MQTT_BROKER_PORT"))
    },

    # "device": "TD201",  # DK201, TD201, ZL203
    "device": os.getenv("DEVICE_TYPE", "ZL203"),

    # main 主码流, sub子码流
    "hk_subtype": os.getenv("HIK_SUBTYPE", "sub"),

    "TD201_capture_path": "/var/w2s/tmpfs/capture.jpg",
    "TD201_airesult_path": "/var/w2s/tmpfs/airesult.json",

    "poseidon_id_path": "/etc/asp/id",
    "jxcore_id_path": "/etc/hostname",

    "poseidon_file_path": "/data/webConfig/w2s/poseidon.yaml",
    "cloud_point_path": "/etc/asp/config.yaml",
    "get_ip_url": "http://{}:9999/ip".format(gateway_addr),
    "update_time_url": "http://{}:9999/api/v1/system/date".format(gateway_addr),

    "default_plc": "sxd0020_bx3",

    # function table
    # poninter: func -> ai model
    # dependencies: func -> func
    "function": {
        "no_helmet": {
            "title": "未佩戴安全帽",
            "pointer": ["ada9e2da90"],
            "dependencies": [],
            "enable": True,
            "aggreagate": 60,
            "aggreagate_times": 1,
            "detection_cycle": {
                "detection_period": [0, 1, 2, 3, 4, 5, 6],
                "detection_time": [
                    {
                        "starttime": 0 * 60 * 60,
                        "endtime": 24 * 60 * 60,
                    },
                ],
            },
            "alert_level": "general",  # general or urgent
            "init_threshold": 0.2,
        },

        # "fire": {
        #     "title": "火焰",
        #     "pointer": ["ada9e2da90"],
        #     "dependencies": [],
        #     "enable": True,
        #     "aggreagate": 60,
        #     "aggreagate_times": 1,
        #     "detection_cycle": {
        #         "detection_period": [0,1,2,3,4,5,6],
        #         "detection_time": [
        #             {
        #                 "starttime": 0*60*60,
        #                 "endtime": 24*60*60,
        #             },
        #         ],
        #     },
        #     "alert_level": "general",
        #     "init_threshold": 0.2,
        # },
        "restrict": {
            "title": "进入电子围栏区域",
            "pointer": ["ada9e2da90"],
            "dependencies": [],
            "enable": True,
            "aggreagate": 60,
            "aggreagate_times": 1,
            "detection_cycle": {
                "detection_period": [0, 1, 2, 3, 4, 5, 6],
                "detection_time": [
                    {
                        "starttime": 0 * 60 * 60,
                        "endtime": 24 * 60 * 60,
                    },
                ],
            },
            "alert_level": "general",
            "init_threshold": 0.2,
        },
        # 注意需要使用ai image id的前10位代替ai_model_1
        # "pata": {
        #     "title": "人员攀爬",
        #     "pointer": ["ai_model_1"],
        #     "dependencies": [],
        #     "enable": True,
        #     "aggreagate": 60,
        #     "aggreagate_times": 1,
        #     "detection_cycle": {
        #         "detection_period": [0,1,2,3,4,5,6],
        #         "detection_time": [
        #             {
        #                 "starttime": 0*60*60,
        #                 "endtime": 24*60*60,
        #             },
        #         ],
        #     },
        #     "alert_level": "general",
        #     "init_threshold": 0.2,
        # },
        # "machinery": {
        #     "title": "施工机械靠近",
        #     "pointer": ["ai_model_1"],
        #     "dependencies": [],
        #     "enable": True,
        #     "aggreagate": 60,
        #     "aggreagate_times": 1,
        #     "detection_cycle": {
        #         "detection_period": [0,1,2,3,4,5,6],
        #         "detection_time": [
        #             {
        #                 "starttime": 0*60*60,
        #                 "endtime": 24*60*60,
        #             },
        #         ],
        #     },
        #     "alert_level": "general",
        #     "init_threshold": 0.2,
        # },
        # "smoke":{
        #     "title": "变压器冒烟",
        #     "pointer": ["ai_model_1"],
        #     "dependencies": [],
        #     "enable": True,
        #     "aggreagate": 60,
        #     "aggreagate_times": 1,
        #     "detection_cycle": {
        #         "detection_period": [0,1,2,3,4,5,6],
        #         "detection_time": [
        #             {
        #                 "starttime": 0*60*60,
        #                 "endtime": 24*60*60,
        #             },
        #         ],
        #     },
        #     "alert_level": "general",
        #     "init_threshold": 0.2,
        # },
        # "move":{
        #     "title": "变压器移动",
        #     "pointer": ["ai_model_1"],
        #     "dependencies": [],
        #     "enable": True,
        #     "aggreagate": 60,
        #     "aggreagate_times": 1,
        #     "detection_cycle": {
        #         "detection_period": [0,1,2,3,4,5,6],
        #         "detection_time": [
        #             {
        #                 "starttime": 0*60*60,
        #                 "endtime": 24*60*60,
        #             },
        #         ],
        #     },
        #     "alert_level": "general",
        #     "init_threshold": 0.2,
        # }
    },

    "acl": {
        "auth_model": "/app/backend/auth/auth_model.conf",
        "policy": "/app/backend/auth/policy.csv"
    },
    "debug": False,
    "debug_user": "5cc2c56952a4cf3b5523fe5f",
    "cookie_secret": "whmXA06MtifkaofETXmik7ZPSF111222",
    "login_cookie": "jiangxing_login_water_ticket",
    "xsrf_cookies": False,
    "admin": {
        "name": "admin",
        "password": "21232f297a57a5a743894a0e4a801fc3"
    },

    "host_id": "",  # 注册时候添加
    "host_ip": "",
    "chip_pointer": {},

    # stream
    ## If you have local rtmp server, then you can push your stream to
    ##     172.17.0.1 (inside container) or edgegw.iotedge (on host)
    "stream": {
        # push keeps the rtmp server address
        "push": gateway_addr,
        # if FLV_PORT is not None，use http flv to preview stream
        "flv_port": os.getenv("FLV_PORT")
    },

    # "app_id": "crystal",

    "excel_dir": "/app/backend/excel",

    "alert_first_fetch": 30,

    "routine_interval": 90,
    "routine_failed_interval": 30,
    "capcam_failed_interval": 30,

    "capture_interval": 5,
    "capture_failed_interval": 30,

    "sweeper_interval": 60,
    "sweeper_failed_interval": 60,

    "mqtt_failed_interval": 60,
    ## disk statistic has minor deviation on collecting actual usage,
    ## we DO NOT recommend to set this value smaller than 10%
    "sweep_by_quota": 10,

    "watermark": False,
    "watermark_size": 20,

    "default_capture_interval": 5,

    "alert_aggregation_time": 30,
    "clean_history": False,

    "exporter": {
        "enable": False,
        "url": "http://10.55.4.10:5000",
    },

    # working mode: node or hub
    "mode": "node",

    "recogn_mode": "cluster",  # "cluster" or "local"

    # "chip_pointer": requests.get("http://{}:9999/api/v1/node/container/hostList".format(gateway_addr)).json()['data'],
    # "ai_model_1": {
    #     "address": [e.strip() for e in os.getenv("AI_MODEL_1_ADDR").split(",")],
    #     "extra_command": {},
    # },
    # "ai_model_2": {
    #     "address": [
    #         "10.55.4.38:30009",
    #     ],
    #     "extra_command": {
    #         "command": "get_all_faces"
    #     },
    # },

    "image_extra_command": {
        "ada9e2da90": {},
        "d920ef30fb": {"command": "det_all_carplates"},
    },

    # 历史图片存储默认设置
    "history": {
        "enable": True,
        "storage": 0,  # 0循环存储 1：存满停止
        "sto_freq": 60,  # 图片存储间隔，单位秒
        "sto_days": 30,  # 文件保留天数
        "sto_cap": 0,  # 存储上限，单位GB,0表示不设限
    },
    "alert": {  # 告警数据存储设置
        "enable": True,  # 是否启用
        "storage": 0,  # 0：循环存储 1：存满停止
        "sto_days": 30,  # 文件保留天数
        "sto_cap": 0,  # 存储上限，单位GB
    },
    "upload": {
        "history_enable": True,  # 是否上传历史图片
        # local表示发送历史图片时不需要带上图片，存储在本地存储即可
        "img_type": "local",  # local本地存储/base64/ s3,如果upload=local and history.enable=false 时不上传图片
        "img_freq": 60,  # 定时上传图片间隔，单位秒

        "alert_enable": True,  # 是否上传告警数据
        # 默认为base64，告警图片本地和asp分别存储一份
        "alert_img_type": "base64",  # 同上
    },

    # 采集和识别时段设置
    "detection_cycle": {
        "detection_period": [0, 1, 2, 3, 4, 5, 6],  # 0表示周一 6表示周日
        "detection_time": [{  # 数组，支持多个时间段
            "starttime": 0,  # hour*60*60+minute*60
            "endtime": 24 * 60 * 60
        }]
    },
    "clean_img_num": int(os.getenv("CLEAN_IMG_NUM", 50)),
    "clean_alert_num": int(os.getenv("CLEAN_ALERT_NUM", 50)),

    "facedata": {
        "name": "方桀",
        "faceid": "20200731",
        "feature": [[
            0.04180411249399185, 0.04702962562441826, 0.007838276214897633, 0.010451032780110836, -0.04441685229539871,
            0.057480648159980774, -0.01306377537548542, -0.02090204507112503, -0.031353071331977844,
            -0.08622095733880997,
            0.01828930340707302, -0.007838263176381588, 0.049642376601696014, 0.036578595638275146,
            -0.039191339164972305, 6.683073205948631e-09, 0.0391913540661335, -0.01306377537548542, 0.01567654497921467,
            -0.005225506145507097,
            0.07054443657398224, 0.03135308250784874, 0.0026127630844712257, 0.057480648159980774,
            -0.0026127498131245375, 0.03135308250784874, 0.049642376601696014, 0.01567654497921467,
            0.028740327805280685, -0.03657858073711395,
            -0.03657858073711395, -0.015676531940698624, 0.007838276214897633, 6.683073205948631e-09,
            0.02351481467485428, -0.0026127498131245375, 0.08099545538425446, -0.05225512385368347, 0.08099545538425446,
            -0.018289288505911827,
            -0.01306377537548542, -0.08622095733880997, 0.03396584093570709, 0.013063788414001465, 0.007838276214897633,
            -0.007838263176381588, -0.005225506145507097, -0.04964236542582512, 0.03396584093570709,
            -0.026127558201551437,
            0.06270616501569748, -0.04180409759283066, -0.007838263176381588, -0.010451018810272217,
            -0.0026127498131245375, -0.03657858073711395, 0.01828930340707302, -0.02874031476676464,
            0.020902059972286224, 0.044416867196559906,
            0.06009340658783913, 0.04180411249399185, 0.04180411249399185, -0.018289288505911827, 0.0026127630844712257,
            -0.08360820263624191, -0.047029610723257065, 0.06793167442083359, -0.08622095733880997, 0.05486789345741272,
            -0.06009339168667793, 0.005225519649684429, 6.683073205948631e-09, 0.01828930340707302,
            -0.039191339164972305, 0.01828930340707302, -0.015676531940698624, -0.0731571689248085, 0.03135308250784874,
            0.020902059972286224,
            0.005225519649684429, 0.026127571240067482, 0.013063788414001465, 0.049642376601696014, 0.03396584093570709,
            0.0026127630844712257, 0.07576994597911835, 0.028740327805280685, 0.049642376601696014,
            6.683073205948631e-09,
            0.0836082175374031, 6.683073205948631e-09, -0.007838263176381588, 0.0026127630844712257,
            0.013063788414001465, -0.06270615011453629, -0.010451018810272217, 0.013063788414001465,
            0.057480648159980774, 0.026127571240067482,
            0.026127571240067482, 0.010451032780110836, -0.0731571689248085, -0.054867882281541824,
            -0.04180409759283066, -0.05225512385368347, 0.03396584093570709, 0.05225513502955437, 0.013063788414001465,
            -0.05225512385368347,
            0.0026127630844712257, -0.015676531940698624, -0.0339658297598362, -0.018289288505911827,
            0.01567654497921467, 0.005225519649684429, 0.0391913540661335, -0.015676531940698624, -0.05748063698410988,
            -0.08883371204137802,
            0.06270616501569748, 0.036578595638275146, -0.07054442167282104, -0.023514801636338234,
            -0.023514801636338234, 0.007838276214897633, -0.06270615011453629, 6.683073205948631e-09,
            0.06270616501569748, -0.02090204507112503,
            0.01567654497921467, -0.007838263176381588, 0.01828930340707302, 0.0026127630844712257, 0.0731571838259697,
            -0.0679316595196724, -0.04441685229539871, -0.018289288505911827, -0.05225512385368347, 0.08099545538425446,
            0.01567654497921467, 0.01567654497921467, -0.026127558201551437, 0.03135308250784874, 0.010451032780110836,
            0.04180411249399185, 0.02351481467485428, -0.0339658297598362, 0.028740327805280685, -0.054867882281541824,
            -0.07054442167282104, -0.07838268578052521, -0.05748063698410988, -0.031353071331977844,
            0.06270616501569748, 0.007838276214897633, -0.02090204507112503, -0.04180409759283066, -0.0339658297598362,
            -0.07576993107795715,
            0.09667199850082397, -0.1123485192656517, -0.02090204507112503, -0.0679316595196724, -0.06009339168667793,
            0.020902059972286224, 0.04702962562441826, 0.07576994597911835, -0.02874031476676464, -0.054867882281541824,
            0.04180411249399185, -0.054867882281541824, 0.03135308250784874, 0.044416867196559906, 0.028740327805280685,
            -0.015676531940698624, 0.013063788414001465, 0.013063788414001465, 0.036578595638275146,
            0.010451032780110836,
            -0.09667198359966278, 6.683073205948631e-09, -0.015676531940698624, 0.020902059972286224,
            0.010451032780110836, 0.02351481467485428, 0.01567654497921467, 0.026127571240067482, 0.057480648159980774,
            -0.02874031476676464,
            -0.04180409759283066, 0.06009340658783913, -0.0026127498131245375, -0.06009339168667793,
            -0.08360820263624191, 0.0391913540661335, 0.005225519649684429, 0.049642376601696014, 6.683073205948631e-09,
            -0.02874031476676464,
            -0.06009339168667793, -0.02874031476676464, 0.06793167442083359, 0.09928475320339203, -0.039191339164972305,
            0.013063788414001465, 0.03135308250784874, 0.03396584093570709, 0.03396584093570709, -0.0026127498131245375,
            -0.10451025515794754, -0.015676531940698624, 0.005225519649684429, 0.013063788414001465,
            -0.015676531940698624, -0.09405922889709473, -0.02874031476676464, -0.023514801636338234,
            6.683073205948631e-09, 6.683073205948631e-09,
            -0.01306377537548542, -0.005225506145507097, 0.05225513502955437, -0.015676531940698624,
            -0.07576993107795715, 0.020902059972286224, -0.01306377537548542, -0.0026127498131245375,
            -0.018289288505911827, -0.01306377537548542,
            -0.0339658297598362, 0.005225519649684429, -0.010451018810272217, -0.04180409759283066,
            -0.005225506145507097, 0.0836082175374031, -0.0731571689248085, -0.03657858073711395, 0.05486789345741272,
            0.0836082175374031,
            -0.007838263176381588, -0.07576993107795715, -0.0679316595196724, -0.02090204507112503, 0.09405924379825592,
            0.09928475320339203, 0.06009340658783913, -0.02090204507112503, 0.013063788414001465, -0.02090204507112503,
            0.06009340658783913, -0.01306377537548542, -0.0339658297598362, -0.04180409759283066, -0.04441685229539871,
            0.026127571240067482, -0.07576993107795715, -0.005225506145507097, 0.028740327805280685,
            0.0026127630844712257,
            -0.054867882281541824, -0.04180409759283066, 0.013063788414001465, 0.028740327805280685,
            0.0026127630844712257, 6.683073205948631e-09, 0.036578595638275146, 0.044416867196559906,
            0.01567654497921467, 0.08883372694253922,
            0.007838276214897633, -0.04964236542582512, 0.05225513502955437, -0.04441685229539871,
            -0.005225506145507097, -0.010451018810272217, -0.04964236542582512, 0.013063788414001465,
            -0.0339658297598362, -0.05748063698410988,
            0.07576994597911835, -0.015676531940698624, -0.0026127498131245375, 0.06531891971826553,
            6.683073205948631e-09, -0.05225512385368347, -0.04180409759283066, 0.05225513502955437, 0.07576994597911835,
            -0.0339658297598362,
            0.08622096478939056, -0.08883371204137802, -0.01306377537548542, -0.026127558201551437,
            -0.023514801636338234, 0.044416867196559906, 0.005225519649684429, 0.020902059972286224,
            -0.010451018810272217, -0.039191339164972305,
            0.013063788414001465, 0.05486789345741272, 0.08099545538425446, 0.05486789345741272, -0.0731571689248085,
            -0.06531890481710434, -0.031353071331977844, -0.039191339164972305, 0.07054443657398224,
            -0.08883371204137802,
            0.04180411249399185, 0.013063788414001465, -0.0339658297598362, -0.039191339164972305,
            -0.031353071331977844, -0.07576993107795715, 0.005225519649684429, -0.0339658297598362, 0.03396584093570709,
            0.04702962562441826,
            0.036578595638275146, -0.06270615011453629, 0.06531891971826553, 0.06270616501569748, 0.036578595638275146,
            0.005225519649684429, -0.039191339164972305, -0.01306377537548542, -0.010451018810272217,
            6.683073205948631e-09,
            0.08099545538425446, 0.013063788414001465, 0.013063788414001465, -0.0026127498131245375,
            0.026127571240067482, -0.0026127498131245375, 0.07054443657398224, -0.08622095733880997,
            -0.08883371204137802, -0.07838268578052521,
            0.04180411249399185, 0.005225519649684429, -0.010451018810272217, -0.010451018810272217,
            0.007838276214897633, 0.010451032780110836, 0.005225519649684429, -0.0026127498131245375,
            0.013063788414001465, -0.06531890481710434,
            -0.05748063698410988, -0.06270615011453629, -0.02090204507112503, 0.05225513502955437, 0.007838276214897633,
            -0.04180409759283066, 0.05486789345741272, -0.03657858073711395, -0.010451018810272217, 0.04180411249399185,
            -0.06531890481710434, -0.04180409759283066, 0.08622096478939056, -0.10973577201366425, 0.01567654497921467,
            -0.031353071331977844, -0.010451018810272217, -0.018289288505911827, -0.031353071331977844,
            -0.0339658297598362,
            -0.015676531940698624, -0.01306377537548542, 0.05225513502955437, 0.026127571240067482,
            -0.01306377537548542, 0.036578595638275146, -0.02090204507112503, 0.026127571240067482,
            -0.02874031476676464, 0.0391913540661335,
            -0.1515398621559143, -0.0026127498131245375, 0.07576994597911835, -0.018289288505911827,
            -0.05748063698410988, -0.07054442167282104, -0.02874031476676464, 0.010451032780110836, 0.03135308250784874,
            -0.02874031476676464,
            0.0026127630844712257, -0.018289288505911827, -0.04441685229539871, -0.039191339164972305,
            -0.08883371204137802, -0.010451018810272217, -0.023514801636338234, -0.010451018810272217,
            -0.06531890481710434, -0.05225512385368347,
            -0.06270615011453629, -0.07054442167282104, -0.02090204507112503, -0.047029610723257065,
            -0.007838263176381588, 0.03396584093570709, 0.020902059972286224, -0.01306377537548542, 0.06009340658783913,
            -0.0679316595196724,
            0.10973577946424484, -0.04441685229539871, 6.683073205948631e-09, -0.026127558201551437, 0.0391913540661335,
            0.03396584093570709, -0.01306377537548542, -0.01306377537548542, 0.005225519649684429, 0.057480648159980774,
            0.04702962562441826, -0.07054442167282104, -0.02874031476676464, 0.013063788414001465,
            -0.0026127498131245375, 0.028740327805280685, 6.683073205948631e-09, -0.039191339164972305,
            -0.04441685229539871, -0.018289288505911827,
            0.07054443657398224, -0.06009339168667793, 6.683073205948631e-09, 0.020902059972286224, -0.0731571689248085,
            0.04180411249399185, 0.028740327805280685, -0.04180409759283066, 0.0391913540661335, 0.026127571240067482,
            0.020902059972286224, -0.047029610723257065, -0.02090204507112503, 0.028740327805280685,
            -0.007838263176381588, 0.005225519649684429, -0.0026127498131245375, 0.010451032780110836,
            -0.047029610723257065, -0.054867882281541824,
            -0.04441685229539871, -0.07838268578052521, 0.020902059972286224, 0.044416867196559906, 0.06009340658783913,
            0.036578595638275146, -0.047029610723257065, -0.0026127498131245375, -0.03657858073711395,
            6.683073205948631e-09,
            0.013063788414001465, 0.08622096478939056, 0.04180411249399185, -0.010451018810272217, -0.10189749300479889,
            -0.007838263176381588, 0.06009340658783913, 0.01567654497921467, -0.05225512385368347, -0.06531890481710434,
            -0.023514801636338234, 0.07576994597911835, -0.047029610723257065, 0.02351481467485428,
            0.010451032780110836, 0.007838276214897633, -0.02090204507112503, -0.026127558201551437,
            -0.06531890481710434, -0.0339658297598362,
            -0.04180409759283066, 0.06009340658783913, 0.01567654497921467, -0.010451018810272217,
            6.683073205948631e-09, 0.057480648159980774, 0.04702962562441826, 0.057480648159980774,
            -0.07576993107795715, -0.018289288505911827,
            -0.05748063698410988, 0.06009340658783913, 0.010451032780110836, -0.05748063698410988,
            -0.026127558201551437, -0.005225506145507097, 0.013063788414001465, 0.020902059972286224,
            -0.07054442167282104, 0.0783827006816864,
            0.010451032780110836, -0.018289288505911827, 0.036578595638275146, 0.020902059972286224,
            0.010451032780110836, -0.023514801636338234, -0.02874031476676464, 0.007838276214897633,
            -0.01306377537548542, 0.03135308250784874,
            0.026127571240067482, 0.01828930340707302], ],
    }
}
